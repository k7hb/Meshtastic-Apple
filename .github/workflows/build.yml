name: Build Meshtastic iOS 2.5.7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          ref: refs/tags/2.5.7

      - name: Install dependencies
        run: |
          brew install cocoapods
          pod install --project-directory=.

      - name: Build for iOS
        run: |
          xcodebuild \
            -workspace Meshtastic.xcworkspace \
            -scheme Meshtastic \
            -sdk iphoneos \
            -configuration Release \
            clean build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

      - name: Package .ipa
        run: |
          mkdir -p Payload
          cp -r build/Release-iphoneos/Meshtastic.app Payload/
          zip -r Meshtastic-2.5.7.ipa Payload

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: Meshtastic-2.5.7-ipa
          path: Meshtastic-2.5.7.ipa
